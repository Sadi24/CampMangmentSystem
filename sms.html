<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>رفع ملف Excel وإرسال رسائل</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Arial;
      background: #f6f8fb
    }

    .rtl {
      direction: rtl
    }
  </style>
</head>

<body class="p-4 rtl">
  <div class="container">
    <h1 class="h4 mb-3">رفع ملف Excel وإرسال رسائل للمستفيدين</h1>

    <div class="card p-3 mb-3">
      <label class="form-label">اختر ملف Excel (.xlsx / .xls)</label>
      <input id="fileInput" type="file" class="form-control" accept=".xlsx,.xls,.csv" />
      <div class="form-text">الملف يجب أن يحتوي عمود لرقم الجوال واسم المستفيد (يمكن تسميات مختلفة - اختر الأعمدة بعد
        الرفع).</div>
    </div>

    <div class="card p-3 mb-3">
      <h5>اعدادات الرسائل</h5>
      <div class="mb-2">
        <label class="form-label">قالب الرسالة (استخدم {name} لإدراج اسم المستفيد)</label>
        <textarea id="template" class="form-control" rows="3">مرحباً {name}، هذا إشعار تجريبي.</textarea>
      </div>
      <div class="mb-2 d-flex gap-2">
        <button id="previewBtn" class="btn btn-outline-primary">معاينة الرسائل</button>
        <button id="sendBtn" class="btn btn-success">أرسل الرسائل</button>
        <button id="stopBtn" class="btn btn-danger" disabled>إيقاف</button>
      </div>
      <div class="form-text">ملاحظة: هذه الصفحة ترسل طلبات إلى واجهة خلفية (POST /api/send) — ستجد مثال لخادم Node.js
        داخل الملف.</div>
    </div>

    <div class="card p-3 mb-3">
      <h5>معاينة المستفيدين (<span id="count">0</span>)</h5>
      <div class="table-responsive" style="max-height:300px; overflow:auto">
        <table id="previewTable" class="table table-sm table-striped">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>الجوال</th>
              <th>رسالة (معاينة)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <h5>سجل الإرسال</h5>
      <ul id="log" class="list-group" style="max-height:200px; overflow:auto"></ul>
    </div>

    <footer class="text-muted small">ملاحظة: تحتاج إلى واجهة خلفية آمنة للتعامل مع مفاتيح موفري الرسائل (مثل Twilio /
      MessageBird). في أسفل الملف مثال لخادم Node.js مع Twilio.</footer>
  </div>

  <!-- مكتبة SheetJS لقراءة Excel في المتصفح -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // إعدادات
    const fileInput = document.getElementById('fileInput');
    const previewTableBody = document.querySelector('#previewTable tbody');
    const countEl = document.getElementById('count');
    const templateEl = document.getElementById('template');
    const previewBtn = document.getElementById('previewBtn');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const logEl = document.getElementById('log');

    let rows = []; // بعد التحليل: {name, phone}
    let sending = false;

    function appendLog(text, cls = '') {
      const li = document.createElement('li'); li.className = 'list-group-item ' + cls; li.textContent = text;
      logEl.prepend(li);
    }

    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const first = wb.SheetNames[0];
      const sheet = wb.Sheets[first];
      const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      // حاول العثور على الأعمدة الأكثر احتمالاً لاسم وجوال
      const candidates = data.map(r => Object.keys(r));
      // نحدد أفضل أخذ للأعمدة بالبحث عن عناوين متوقعة
      const guessPhoneKeys = ['phone', 'mobile', 'tel', 'الجوال', 'رقم', 'رقم الهاتف', 'الهاتف'];
      const guessNameKeys = ['name', 'fullName', 'الاسم', 'الاسم الكامل', 'اسم'];

      // اختيار أول مفتاح مطابق
      const keys = Object.keys(data[0] || {});
      let phoneKey = keys.find(k => guessPhoneKeys.includes(k.toLowerCase())) || keys.find(k => /phone|mobile|tel|رقم/i.test(k));
      let nameKey = keys.find(k => guessNameKeys.includes(k.toLowerCase())) || keys.find(k => /name|الاسم/i.test(k));

      // إذا لم نجد، استخدم أول عمودين
      if (!phoneKey && keys.length > 0) phoneKey = keys[keys.length - 1];
      if (!nameKey && keys.length > 0) nameKey = keys[0];

      rows = data.map(r => ({
        name: String(r[nameKey] || '').trim(),
        phone: String(r[phoneKey] || '').trim()
      })).filter(r => r.phone);

      renderPreview();
      appendLog(`تم تحميل ${rows.length} مستفيد من الملف.`);
    });

    function renderPreview() {
      previewTableBody.innerHTML = '';
      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        const msg = generateMessage(r);
        tr.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.phone)}</td><td>${escapeHtml(msg)}</td>`;
        previewTableBody.appendChild(tr);
      });
      countEl.textContent = rows.length;
    }

    function generateMessage(r) {
      return templateEl.value.replaceAll('{name}', r.name || '').slice(0, 1600);
    }

    previewBtn.addEventListener('click', () => {
      if (rows.length === 0) { alert('لم يتم تحميل أي مستفيدين'); return; }
      renderPreview();
      appendLog('تم تحديث المعاينة.');
    });

    // إرسال الطلبات إلى الخلفية بمعدل متحكم (دون مفاتيح API في الواجهة)
    async function sendAll() {
      if (rows.length === 0) { alert('لا يوجد مستفيدين لإرسال الرسائل'); return; }
      if (!confirm(`هل تريد إرسال ${rows.length} رسالة الآن؟`)) return;
      sending = true; sendBtn.disabled = true; stopBtn.disabled = false; appendLog('بدء الإرسال...');

      const delayMs = 500; // فاصل بين كل رسالة — غيّره حسب احتياجات مزود الخدمة

      for (let i = 0; i < rows.length; i++) {
        if (!sending) { appendLog('تم إيقاف الإرسال يدوياً.'); break; }
        const r = rows[i];
        const message = generateMessage(r);
        try {
          // استدعاء خلفي: POST /api/send  - تتوقع {to, message}
          const res = await fetch('/api/send', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to: r.phone, message })
          });
          if (!res.ok) {
            const txt = await res.text();
            appendLog(`خطأ عند الإرسال إلى ${r.phone}: ${res.status} ${txt}`, 'list-group-item-danger');
          } else {
            appendLog(`تم الإرسال إلى ${r.phone} (${i + 1}/${rows.length})`, 'list-group-item-success');
          }
        } catch (err) {
          appendLog(`فشل الإرسال إلى ${r.phone}: ${err.message}`, 'list-group-item-danger');
        }
        await new Promise(s => setTimeout(s, delayMs));
      }

      sending = false; sendBtn.disabled = false; stopBtn.disabled = true; appendLog('انتهى مسار الإرسال.');
    }

    sendBtn.addEventListener('click', () => { sendAll(); });
    stopBtn.addEventListener('click', () => { sending = false; stopBtn.disabled = true; });

    function escapeHtml(s) { return String(s).replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])); }
  </script>

  <!-- مثال لخادم Node.js (Express) مع Twilio — ضع هذا الملف في الخادم ولا تضع مفاتيحك في الواجهة الأمامية -->
  <!--
  // server.js  (مثال)
  const express = require('express');
  const bodyParser = require('body-parser');
  const twilio = require('twilio');
  require('dotenv').config();

  const app = express();
  app.use(bodyParser.json());

  const client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);

  app.post('/api/send', async (req, res) => {
    const { to, message } = req.body;
    if (!to || !message) return res.status(400).send('Bad request');
    try {
      const m = await client.messages.create({ body: message, from: process.env.TWILIO_FROM, to });
      res.json({ ok: true, sid: m.sid });
    } catch (err) {
      console.error(err);
      res.status(500).send(err.message || 'Error');
    }
  });

  app.listen(3000, ()=>console.log('Server running on 3000'));
  -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>